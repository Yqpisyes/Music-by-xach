<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Xa_CHã®Music</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background: radial-gradient(circle at center, #764ba2 0%, #667eea 30%, #4ca1af 60%, #2c3e50 100%);
            background-size: 150% 150%;
            animation: moveBg 12s ease-in-out infinite alternate;
            height: 100vh; display: flex; align-items: center; justify-content: center;
            font-family: "Microsoft YaHei", sans-serif; color: white; overflow: hidden;
        }

        @keyframes moveBg { 0% { background-position: center; } 100% { background-position: 20% 20%; } }

        .player-card {
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            padding: 30px; border-radius: 35px;
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.3);
            width: 92%; max-width: 420px; border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex; flex-direction: column; transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* --- æ­Œè¯æŠ˜å é€»è¾‘ --- */
        .lyrics-container {
            max-height: 0; /* åˆå§‹éšè— */
            opacity: 0;
            overflow: hidden;
            margin: 0;
            position: relative;
            transition: max-height 0.6s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.4s, margin 0.4s;
            mask-image: linear-gradient(to bottom, transparent, black 25%, black 75%, transparent);
            -webkit-mask-image: linear-gradient(to bottom, transparent, black 25%, black 75%, transparent);
        }

        /* æ’­æ”¾æ—¶å±•å¼€çš„ç±» */
        .lyrics-active {
            max-height: 220px;
            opacity: 1;
            margin: 15px 0;
        }

        #lyrics-wrapper { transition: transform 0.4s ease-out; text-align: center; }

        .lyric-line {
            padding: 10px 15px; font-size: 0.95rem; opacity: 0.2;
            transition: all 0.4s ease; min-height: 40px; line-height: 1.5;
        }
        .lyric-line.active { opacity: 1; transform: scale(1.05); font-weight: bold; }
        .translation { display: block; font-size: 0.8em; opacity: 0.7; margin-top: 4px; font-weight: normal; }

        /* --- å“åº”å¼å¸ƒå±€ï¼ˆç”µè„‘ç«¯ä¿æŒä¸å˜ï¼‰ --- */
        @media (min-width: 850px) {
            .player-card { max-width: 950px; flex-direction: row; gap: 40px; padding: 40px; }
            .main-player-part { flex: 1.2; }
            .playlist-container { flex: 0.8; height: 480px; }
            .lyrics-container { max-height: 220px; opacity: 1; margin: 20px 0; } /* ç”µè„‘ç«¯é»˜è®¤å±•å¼€ */
        }

        /* æ‰‹æœºç«¯åˆ—è¡¨æ»šåŠ¨ä¼˜åŒ– */
        @media (max-width: 849px) {
            .player-card { max-height: 95vh; }
            .playlist-container {
                max-height: 300px;
                overflow-y: auto;
                margin-top: 10px;
                border-top: 1px solid rgba(255,255,255,0.1);
                padding-top: 10px;
                scrollbar-width: none;
            }
            .playlist-container::-webkit-scrollbar { display: none; }
        }

        /* å…¶ä»–æ§ä»¶æ ·å¼ */
        .site-title { font-size: 0.65rem; opacity: 0.6; letter-spacing: 4px; margin-bottom: 12px; text-transform: uppercase; }
        .title-wrapper { height: 2.2rem; margin-bottom: 15px; display: flex; align-items: center; font-size: 1.1rem; font-weight: bold; }
        #cursor { width: 2px; height: 1.1rem; background-color: #fff; margin-left: 6px; animation: blink 0.8s infinite; }
        @keyframes blink { 50% { opacity: 0; } }
        .controls-row { background: rgba(0, 0, 0, 0.2); padding: 18px; border-radius: 22px; display: flex; align-items: center; gap: 18px; }
        .progress-section { flex: 1; }
        .progress-container { width: 100%; height: 6px; background: rgba(255, 255, 255, 0.1); border-radius: 3px; cursor: pointer; position: relative; margin-bottom: 6px; }
        .progress-bar { width: 0%; height: 100%; background: #fff; border-radius: 3px; }
        .time-info { display: flex; justify-content: space-between; font-size: 0.65rem; opacity: 0.5; font-family: monospace; }
        .play-btn { width: 48px; height: 48px; background: #fff; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .play-btn svg { fill: #2c3e50; width: 20px; height: 20px; }
        .song-item { padding: 12px 18px; background: rgba(255, 255, 255, 0.05); margin-bottom: 8px; border-radius: 12px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; }
        .song-item:hover { background: rgba(255, 255, 255, 0.08); }
        .song-item.active { background: #fff; color: #2c3e50; }
        .song-name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 0.85rem; }
    </style>
</head>
<body>

    <div class="player-card">
        <div class="main-player-part">
            <div class="site-title">Xa_CHã®Music</div>
            <div class="title-wrapper">
                <div id="current-title"></div>
                <div id="cursor"></div>
            </div>

            <div class="lyrics-container" id="lyric-box">
                <div id="lyrics-wrapper"></div>
            </div>

            <audio id="audio-engine"></audio>

            <div class="controls-row">
                <div class="progress-section">
                    <div class="progress-container" id="progress-container">
                        <div class="progress-bar" id="progress-bar"></div>
                    </div>
                    <div class="time-info">
                        <span id="current-time">00:00</span>
                        <span id="duration">00:00</span>
                    </div>
                </div>
                <button class="play-btn" id="play-pause-btn">
                    <svg id="play-icon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                    <svg id="pause-icon" style="display:none" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                </button>
            </div>
        </div>

        <div class="playlist-container">
            <ul class="playlist" style="list-style: none;">
                <!-- æ­Œæ›²åˆ—è¡¨å°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </ul>
        </div>
    </div>

    <script>
        const audio = document.getElementById('audio-engine');
        const playBtn = document.getElementById('play-pause-btn');
        const playIcon = document.getElementById('play-icon');
        const pauseIcon = document.getElementById('pause-icon');
        const progressBar = document.getElementById('progress-bar');
        const progressContainer = document.getElementById('progress-container');
        const currTimeText = document.getElementById('current-time');
        const durationText = document.getElementById('duration');
        const titleDisplay = document.getElementById('current-title');
        const lyricsWrapper = document.getElementById('lyrics-wrapper');
        const lyricBox = document.getElementById('lyric-box');
        const playlistContainer = document.querySelector('.playlist-container .playlist');
        
        let musicList = [];          // å­˜å‚¨ä»JSONåŠ è½½çš„æ­Œæ›²åˆ—è¡¨
        let currentIndex = -1;
        let isPlayingMusic = false;
        let lyricData = [];
        let typeTimer = null;

        // è§£ææ­Œè¯
        function parseLyric(text) {
            const lines = text.split('\n');
            const result = [];
            const pattern = /\[(\d{2}):(\d{2})\.(\d{2,3})\](.*)/;
            const tempMap = {};
            lines.forEach(line => {
                const matches = pattern.exec(line);
                if (matches) {
                    const minutes = parseInt(matches[1]);
                    const seconds = parseInt(matches[2]);
                    const milliseconds = parseInt(matches[3].padEnd(3, '0'));
                    const timeKey = (minutes * 60 + seconds + milliseconds / 1000).toFixed(3);
                    const content = matches[4].trim();
                    if (content) {
                        if (tempMap[timeKey]) {
                            // å¦‚æœæœ‰ç›¸åŒæ—¶é—´æˆ³ï¼Œè§†ä¸ºç¿»è¯‘ï¼Œç”¨spanåŒ…è£¹
                            tempMap[timeKey] += `<span class="translation">${content}</span>`;
                        } else {
                            tempMap[timeKey] = content;
                        }
                    }
                }
            });
            for (let time in tempMap) {
                result.push({ time: parseFloat(time), content: tempMap[time] });
            }
            result.sort((a, b) => a.time - b.time);
            return result;
        }

        async function loadLyrics(fileName) {
            try {
                const response = await fetch(`./lrc/${fileName}.lrc`);
                const text = await response.text();
                lyricData = parseLyric(text);
                renderLyrics();
            } catch (err) {
                lyricData = [{time: 0, content: "æš‚æ— æ­Œè¯"}];
                renderLyrics();
            }
        }

        function renderLyrics() {
            if (!lyricData || lyricData.length === 0) {
                lyricsWrapper.innerHTML = '<div class="lyric-line">æš‚æ— æ­Œè¯</div>';
                return;
            }
            lyricsWrapper.innerHTML = lyricData.map(line => `<div class="lyric-line">${line.content}</div>`).join('');
            syncLyricPos(0);
        }

        function syncLyricPos(index) {
            const lines = document.querySelectorAll('.lyric-line');
            if (!lines.length || !lines[index]) return;
            
            // æ›´æ–°æ¿€æ´»çŠ¶æ€
            lines.forEach((l, i) => l.classList.toggle('active', i === index));
            
            // è®¡ç®—åç§»ä½¿å½“å‰æ­Œè¯å±…ä¸­
            const containerHeight = lyricBox.clientHeight;
            const lineHeight = lines[index].offsetHeight;
            const lineTop = lines[index].offsetTop;
            // ç›®æ ‡ä½ç½®ï¼šè®©å½“å‰æ­Œè¯ä½äºå®¹å™¨ä¸­é—´åä¸Šä¸€ç‚¹
            const targetOffset = (containerHeight / 2) - lineTop - (lineHeight / 2);
            lyricsWrapper.style.transform = `translateY(${targetOffset}px)`;
        }

        // æ‰“å­—æœºæ•ˆæœ
        const phrases = ["ç­”æ¡ˆåœ¨è·¯å£ï¼Œä¸åœ¨å°½å¤´ ğŸŒ¿", "æ„¿æ—‹å¾‹æ²»æ„ˆä½ çš„ä»Šæ—¥ä»½ä¸å¼€å¿ƒ âœ¨"];
        let phraseIdx = 0, charIdx = 0, isDeleting = false;
        function typeEffect() {
            if (isPlayingMusic) return;
            const current = phrases[phraseIdx];
            titleDisplay.innerText = current.substring(0, charIdx);
            
            let speed = isDeleting ? 60 : 120;
            
            if (!isDeleting && charIdx === current.length) {
                speed = 2000; // åœç•™æ—¶é—´
                isDeleting = true;
            } else if (isDeleting && charIdx === 0) {
                isDeleting = false;
                phraseIdx = (phraseIdx + 1) % phrases.length;
                speed = 500;
            } else {
                charIdx = isDeleting ? charIdx - 1 : charIdx + 1;
            }
            
            typeTimer = setTimeout(typeEffect, speed);
        }

        async function playSong(index) {
            if (!musicList.length || index < 0 || index >= musicList.length) return;
            
            isPlayingMusic = true;
            clearTimeout(typeTimer);
            document.getElementById('cursor').style.display = 'none';
            
            // æ‰‹æœºç«¯å±•å¼€æ­Œè¯
            lyricBox.classList.add('lyrics-active');
            
            currentIndex = index;
            
            // æ›´æ–°åˆ—è¡¨æ¿€æ´»çŠ¶æ€
            const songItems = document.querySelectorAll('.song-item');
            songItems.forEach((li, i) => li.classList.toggle('active', i === currentIndex));
            
            const item = musicList[currentIndex];
            audio.src = item.src;
            titleDisplay.innerText = item.name;
            
            await loadLyrics(item.lrc);
            
            try {
                await audio.play();
                playIcon.style.display = 'none';
                pauseIcon.style.display = 'block';
            } catch (e) {
                console.log('æ’­æ”¾å¤±è´¥:', e);
                // è‡ªåŠ¨æ’­æ”¾å¯èƒ½è¢«æµè§ˆå™¨é˜»æ­¢
                isPlayingMusic = false;
                playIcon.style.display = 'block';
                pauseIcon.style.display = 'none';
            }
        }

        // æ’­æ”¾æŒ‰é’®ç‚¹å‡»
        playBtn.onclick = () => {
            if (currentIndex === -1 && musicList.length > 0) {
                playSong(0);
                return;
            }
            
            if (audio.paused) {
                audio.play().then(() => {
                    playIcon.style.display = 'none';
                    pauseIcon.style.display = 'block';
                }).catch(e => console.log('æ’­æ”¾å¤±è´¥:', e));
            } else {
                audio.pause();
                playIcon.style.display = 'block';
                pauseIcon.style.display = 'none';
            }
        };

        // è¿›åº¦æ›´æ–°
        audio.ontimeupdate = () => {
            if (!audio.duration) return;
            const percent = (audio.currentTime / audio.duration) * 100;
            progressBar.style.width = percent + '%';
            currTimeText.innerText = formatTime(audio.currentTime);
            
            // æ­Œè¯åŒæ­¥
            if (lyricData.length > 0) {
                let activeIndex = -1;
                for (let i = 0; i < lyricData.length; i++) {
                    const current = lyricData[i];
                    const next = lyricData[i + 1];
                    
                    if (audio.currentTime >= current.time && (!next || audio.currentTime < next.time)) {
                        activeIndex = i;
                        break;
                    }
                }
                
                if (activeIndex !== -1 && activeIndex !== currentActiveLine) {
                    currentActiveLine = activeIndex;
                    syncLyricPos(activeIndex);
                }
            }
        };

        // è®°å½•å½“å‰æ¿€æ´»çš„æ­Œè¯è¡Œï¼Œé¿å…é‡å¤æ›´æ–°
        let currentActiveLine = -1;

        // ç‚¹å‡»è¿›åº¦æ¡è·³è½¬
        progressContainer.onclick = (e) => {
            const rect = progressContainer.getBoundingClientRect();
            const clickPos = (e.clientX - rect.left) / rect.width;
            audio.currentTime = clickPos * audio.duration;
        };

        audio.onloadedmetadata = () => { 
            durationText.innerText = formatTime(audio.duration);
        };
        
        audio.onended = () => {
            playSong((currentIndex + 1) % musicList.length);
        };

        function formatTime(secs) {
            if (isNaN(secs)) return '00:00';
            const mins = Math.floor(secs / 60);
            const seconds = Math.floor(secs % 60);
            return `${mins.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // ä»JSONåŠ è½½éŸ³ä¹åˆ—è¡¨å¹¶ç”ŸæˆDOM
        async function loadMusicList() {
            try {
                const response = await fetch('musiclist.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                musicList = await response.json();
                
                // æ¸…ç©ºç°æœ‰åˆ—è¡¨
                playlistContainer.innerHTML = '';
                
                // åŠ¨æ€ç”Ÿæˆæ­Œæ›²é¡¹
                musicList.forEach((song, index) => {
                    const li = document.createElement('li');
                    li.className = 'song-item';
                    li.setAttribute('data-src', song.src);
                    li.setAttribute('data-lrc-file', song.lrc);
                    
                    const span = document.createElement('span');
                    span.className = 'song-name';
                    span.innerText = song.name;
                    
                    li.appendChild(span);
                    li.onclick = () => playSong(index);
                    playlistContainer.appendChild(li);
                });
                
                // å¦‚æœæœ‰æ­Œæ›²ï¼Œé»˜è®¤é€‰ä¸­ç¬¬ä¸€é¦–ä½†ä¸æ’­æ”¾
                if (musicList.length > 0) {
                    const firstItem = document.querySelector('.song-item');
                    if (firstItem) {
                        // åªæ˜¾ç¤ºæ ‡é¢˜ï¼Œä¸è‡ªåŠ¨æ’­æ”¾
                        titleDisplay.innerText = musicList[0].name;
                    }
                }
            } catch (error) {
                console.error('åŠ è½½éŸ³ä¹åˆ—è¡¨å¤±è´¥ï¼š', error);
                playlistContainer.innerHTML = '<li style="padding: 20px; text-align: center; color: #ff9999;">åŠ è½½æ­Œæ›²å¤±è´¥ï¼Œè¯·æ£€æŸ¥ musiclist.json æ˜¯å¦å­˜åœ¨</li>';
            }
        }

        // å¯åŠ¨
        loadMusicList();
        typeEffect();

        // å¤„ç†éŸ³é¢‘åŠ è½½é”™è¯¯
        audio.onerror = () => {
            console.error('éŸ³é¢‘åŠ è½½å¤±è´¥:', audio.src);
            playIcon.style.display = 'block';
            pauseIcon.style.display = 'none';
        };

        // å½“éŸ³é¢‘æš‚åœæ—¶
        audio.onpause = () => {
            playIcon.style.display = 'block';
            pauseIcon.style.display = 'none';
        };

        // å½“éŸ³é¢‘æ’­æ”¾æ—¶
        audio.onplay = () => {
            playIcon.style.display = 'none';
            pauseIcon.style.display = 'block';
            isPlayingMusic = true;
        };
    </script>
</body>
</html>
